<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VistaGeomatics – Grading Check</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <!-- PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- PDF upload preview (PDF.js) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <style>
    :root{
      --vista-blue:#165f7d;
      --vista-blue-light:#2a7fa3;
      --vista-blue-dark:#0b3045;

      --bg-body:#eef3f9;
      --bg-card:#ffffff;
      --border-soft:#d6e2f0;

      --text-main:#101827;
      --text-muted:#5b6777;

      --ok:#15803d;
      --bad:#b91c1c;

      --shadow: 0 10px 30px rgba(2, 10, 20, 0.08);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Inter", sans-serif;
      background: radial-gradient(circle at top, #f4fbff 0%, var(--bg-body) 55%, #e9f1fb 100%);
      color:var(--text-main);
    }

    .wrap{ max-width: 1180px; margin: 20px auto 60px; padding: 0 16px; }

    .topbar{
      background: linear-gradient(135deg, var(--vista-blue-dark), var(--vista-blue));
      color:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      gap:16px;
      padding: 16px 18px;
      flex-wrap:wrap;
    }

    .logo{
      width: 54px; height: 54px; border-radius: 12px;
      background: rgba(255,255,255,0.12);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; flex: 0 0 auto;
    }
    .logo img{ width: 100%; height: 100%; object-fit: contain; padding: 8px; }

    .brand{ flex:1 1 auto; min-width: 220px; }
    .brand .title{
      font-family:"Montserrat", sans-serif;
      font-weight:700; letter-spacing:0.5px;
      font-size: 18px; margin:0; line-height:1.2;
    }
    .brand .subtitle{ margin:4px 0 0; opacity:0.9; font-size: 13px; }

    .pill{
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      padding:10px 12px; border-radius: 999px;
      flex: 0 0 auto; white-space: nowrap;
    }
    .pill b{ font-weight:700; }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .pill{ width:100%; justify-content:space-between; }
    }

    .card{
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-h{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      flex-wrap: wrap;
    }
    .card-h h2{ margin:0; font-size: 14px; letter-spacing:0.2px; }
    .card-b{ padding: 14px 16px 16px; }

    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){ .formgrid{ grid-template-columns:1fr; } }

    label{ display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }

    input, select, textarea{
      width:100%;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      outline:none;
      background:#fff;
      color: var(--text-main);
    }
    textarea{ min-height: 86px; resize: vertical; }

    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.0);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight:600;
      cursor:pointer;
      transition: transform 0.05s ease, opacity 0.15s ease, background 0.15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg, var(--vista-blue), var(--vista-blue-light)); color:#fff; }
    .btn.ghost{ background: #f4f8fc; border: 1px solid var(--border-soft); color: var(--text-main); }
    .btn.danger{ background: #fff1f2; border: 1px solid #fecdd3; color: var(--bad); }

    .hint{ font-size: 12px; color: var(--text-muted); margin-top: 8px; line-height: 1.35; }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border: 1px solid var(--border-soft);
      border-radius: 14px;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 10px;
      background: #f6fafc;
      border-bottom: 1px solid var(--border-soft);
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-soft);
      vertical-align: middle;
      font-size: 14px;
    }
    tbody tr:last-child td{ border-bottom: none; }

    td .mini{ padding: 8px 8px; border-radius: 10px; font-size: 13px; }

    .status{
      font-weight: 700;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-block;
      border: 1px solid transparent;
    }
    .status.ok{ color: var(--ok); background: #eaf7ee; border-color: #c7ecd2; }
    .status.bad{ color: var(--bad); background: #fff1f2; border-color: #fecdd3; }
    .status.na{ color: #475569; background: #eef2f7; border-color: #d6dee9; }

    .delta{ font-weight: 800; letter-spacing:0.1px; }
    .delta.ok{ color: var(--ok); }
    .delta.bad{ color: var(--bad); }
    .delta.na{ color:#475569; }

    .summary{
      display:flex; gap: 12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top: 10px;
      padding: 12px 12px;
      border: 1px dashed var(--border-soft);
      border-radius: 14px;
      background: #fbfdff;
    }
    .summary .k{ font-size: 12px; color: var(--text-muted); }
    .summary .v{ font-weight: 800; font-size: 14px; }

    /* Plan preview + click markers */
    .planPreview{
      border: 1px solid var(--border-soft);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 6px 16px rgba(2,10,20,0.06);
    }
    .planStage{
      position: relative;
      width: 100%;
      background:#fff;
      cursor: crosshair;
      user-select: none;
    }
    .planStage img{ width:100%; height:auto; display:block; }

    .marker{
      position:absolute;
      transform: translate(-50%, -100%);
      background: rgba(22,95,125,0.92);
      color:#fff;
      border: 2px solid rgba(255,255,255,0.9);
      border-radius: 999px;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 800;
      box-shadow: 0 8px 18px rgba(2,10,20,0.18);
      pointer-events: auto;
      cursor: pointer;
      white-space: nowrap;
    }
    .marker::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-8px;
      transform: translateX(-50%);
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:8px solid rgba(22,95,125,0.92);
    }

    .planMeta{
      padding: 10px 12px;
      border-top: 1px solid var(--border-soft);
      background:#fafcff;
      font-size:12px;
      color:#334155;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }

    .inlineToggle{
      display:flex;
      gap:8px;
      align-items:center;
      font-size:12px;
      color: var(--text-muted);
      padding: 8px 10px;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      background:#fbfdff;
    }
    .inlineToggle input{ width:auto; }

    /* Export host */
    #exportHost{
      position: fixed;
      left: -99999px;
      top: 0;
      width: 816px; /* ~8.5" at 96dpi */
      background: #fff;
      color:#101827;
    }
    .report{ padding: 18px 18px 22px; font-family:"Inter", sans-serif; }
    .reportHeader{
      display:flex; gap:12px; align-items:center;
      border-bottom: 2px solid #e5edf7;
      padding-bottom: 12px; margin-bottom: 12px;
    }
    .reportLogo{
      width: 52px; height: 52px; border-radius: 12px;
      border: 1px solid #e5edf7;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; background:#fff;
    }
    .reportLogo img{ width:100%; height:100%; object-fit:contain; padding:8px; }
    .reportTitle{
      font-family:"Montserrat", sans-serif;
      font-weight:700; letter-spacing:0.5px;
      margin:0; font-size: 16px; color:#0b3045;
    }
    .reportSub{ margin:4px 0 0; font-size: 12px; color:#475569; }
    .reportMeta{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 8px 12px; margin: 10px 0 14px;
      font-size: 12px; color:#334155;
    }
    .reportMeta b{ color:#0b3045; }
    .reportSectionTitle{
      font-family:"Montserrat", sans-serif;
      font-weight:700; font-size: 13px;
      color:#0b3045; margin: 14px 0 8px;
    }
    .reportTable{
      width:100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .reportTable th, .reportTable td{
      border: 1px solid #d6dee9;
      padding: 6px 6px;
      vertical-align: top;
    }
    .reportTable th{
      background:#f6fafc;
      color:#334155;
      font-weight:700;
      text-align:left;
    }
    .pillSmall{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 800;
      border: 1px solid #d6dee9;
      background:#eef2f7;
      color:#334155;
      white-space:nowrap;
    }
    .pillSmall.ok{ background:#eaf7ee; border-color:#c7ecd2; color:#15803d; }
    .pillSmall.bad{ background:#fff1f2; border-color:#fecdd3; color:#b91c1c; }

    .pageBreak{ page-break-before: always; }

    /* Plan in PDF export with markers baked in */
    .planPrintWrap{
      border:1px solid #d6dee9;
      border-radius:12px;
      overflow:hidden;
    }
    .planPrintStage{ position: relative; }
    .planPrintStage img{ width:100%; height:auto; display:block; }
    .planPrintMarker{
      position:absolute;
      transform: translate(-50%, -100%);
      background: rgba(22,95,125,0.92);
      color:#fff;
      border: 2px solid rgba(255,255,255,0.9);
      border-radius:999px;
      padding: 3px 7px;
      font-size: 11px;
      font-weight: 900;
      white-space: nowrap;
    }
    .planPrintMarker::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-7px;
      transform: translateX(-50%);
      width:0; height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid rgba(22,95,125,0.92);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="logo" title="Vista Geomatics">
          <img src="vista-geomatics.png" alt="Vista Geomatics Logo" />
        </div>

        <div class="brand">
          <p class="title">VISTA GEOMATICS</p>
          <p class="subtitle">Survey Grading Check, Plot Plan vs Field, Click-to-Add Points, PDF Export</p>
        </div>

        <div class="pill">
          <span><b>Area</b></span>
          <select id="areaSelect" style="width:auto; background: rgba(255,255,255,0.95); color:#0b3045; border:none; border-radius:999px; padding:8px 10px;">
            <option value="calgary">Calgary</option>
            <option value="chestermere">Chestermere</option>
            <option value="airdrie">Airdrie</option>
          </select>
        </div>

        <div class="pill">
          <span><b>Tolerance</b></span>
          <span id="tolLabel">±15 cm</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <h2>Job Details</h2>
          <div class="btnbar">
            <button class="btn ghost" id="btnSave" type="button">Save</button>
            <button class="btn ghost" id="btnReset" type="button">Clear</button>
            <button class="btn primary" id="btnPDF" type="button">Export PDF</button>
            <button class="btn primary" id="btnShare" type="button">Share PDF</button>
          </div>
        </div>
        <div class="card-b">
          <div class="formgrid">
            <div>
              <label>Job Number</label>
              <input id="jobNo" placeholder="e.g., 25-0123" autocomplete="off" />
            </div>
            <div>
              <label>Date</label>
              <input id="jobDate" type="date" />
            </div>
            <div>
              <label>Community / Subdivision</label>
              <input id="community" placeholder="e.g., Cornerstone" autocomplete="off" />
            </div>
            <div>
              <label>Address</label>
              <input id="address" placeholder="e.g., 2053–2055 Cornerstone Blvd NE" autocomplete="off" />
            </div>
            <div>
              <label>Lot / Block / Plan</label>
              <input id="lotBlockPlan" placeholder="e.g., Lot 12, Block 3, Plan ____" autocomplete="off" />
            </div>
            <div>
              <label>Crew Chief</label>
              <input id="crewChief" placeholder="Name" autocomplete="off" />
            </div>
          </div>

          <div class="summary" style="margin-top:14px;">
            <div><div class="k">Points Checked</div><div class="v" id="sumPoints">0</div></div>
            <div><div class="k">Fails</div><div class="v" id="sumFails">0</div></div>
            <div><div class="k">Worst Δ (cm)</div><div class="v" id="sumWorst">—</div></div>
            <div><div class="k">Plan Points</div><div class="v" id="sumPlanPts">0</div></div>
          </div>

          <div class="hint">
            Click points on the plan to add point number and field elevation quickly, everything exports or shares as PDF.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h2>Mode</h2>
        </div>
        <div class="card-b">
          <div class="inlineToggle" title="If checked, clicking on the plan prompts for point # and field elevation and inserts/updates the table.">
            <input id="planClickMode" type="checkbox" checked />
            <span><b>Plan Click Mode</b> (tap plan to add points)</span>
          </div>

          <div class="inlineToggle" style="margin-top:10px;" title="If checked, numeric points are automatically sorted 1,2,3... while non-numeric setup rows stay above.">
            <input id="autoSortPoints" type="checkbox" checked />
            <span><b>Auto-sort numeric points</b></span>
          </div>

          <div class="hint" style="margin-top:10px;">
            Tip: Setup rows like RMOW, TP, LMOW stay above, numbered points sort automatically.
          </div>
        </div>
      </div>

      <!-- Plot plan -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Marked Up Plot Plan (Image or PDF)</h2>
          <div class="btnbar">
            <label class="btn ghost" style="cursor:pointer;">
              Upload Plot Plan
              <input id="planInput" type="file" accept="image/*,application/pdf" style="display:none;">
            </label>
            <button class="btn danger" id="btnClearPlan" type="button">Remove</button>
            <button class="btn ghost" id="btnClearMarkers" type="button">Clear Markers</button>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-top:0;">
            Upload the marked-up plan. Then click where the shot was taken, enter Point # and Field Elev, the form updates automatically.
          </div>

          <div id="planEmpty" style="margin-top:12px; padding:14px; border:1px dashed var(--border-soft); border-radius:14px; background:#fbfdff; color:var(--text-muted);">
            No plot plan attached yet.
          </div>

          <div id="planWrap" style="margin-top:12px; display:none;">
            <div class="planPreview">
              <div class="planStage" id="planStage" title="Click on the plan to add a point">
                <img id="planImg" alt="Marked up plot plan preview" />
                <!-- markers injected here -->
              </div>
              <div class="planMeta">
                <div>
                  <b id="planName">—</b>
                  <div id="planType" style="opacity:0.85; margin-top:2px;"></div>
                </div>
                <div class="hint" style="margin:0;">
                  Click a marker to edit or remove it.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Elevation table -->
      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Elevation Comparison (Plot Plan vs Field)</h2>
          <div class="btnbar">
            <button class="btn ghost" id="btnAddRow" type="button">Add Row</button>
            <button class="btn danger" id="btnRemoveSelected" type="button">Remove Selected</button>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-top:0;">
            Δ (cm) = (Field Elev − Design Elev) × 100. Status uses area tolerance.
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:44px;">Sel</th>
                  <th style="min-width:170px;">STA / Point</th>
                  <th style="min-width:160px;">Field Elev</th>
                  <th style="min-width:160px;">Design Elev</th>
                  <th style="min-width:120px;">Δ (cm)</th>
                  <th style="min-width:110px;">Status</th>
                </tr>
              </thead>
              <tbody id="elevBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="exportHost" aria-hidden="true"></div>

  <script>
    // PDF.js worker
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
    }

    const STORAGE_KEY = "vista_grading_check_clickpoints_v1";
    const tolByAreaCm = { calgary: 15, chestermere: 15, airdrie: 10 };

    const state = {
      meta: {
        area: "calgary",
        jobNo: "",
        jobDate: "",
        community: "",
        address: "",
        lotBlockPlan: "",
        crewChief: ""
      },
      elevRows: [],
      plan: null,      // { name, kind, dataUrl }
      markers: []      // { id, xPct, yPct, point, fieldElev }
    };

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    function safeName(s){
      return String(s ?? "")
        .trim()
        .replace(/[\\/:*?"<>|]+/g, "")
        .replace(/\s+/g, " ")
        .replaceAll(" ", "_")
        .slice(0, 80) || "Grading_Check";
    }
    function defaultFileName(ext){
      const job = safeName(state.meta.jobNo || "Job");
      const crew = safeName(state.meta.crewChief || "Crew");
      const date = todayISO();
      return `${job}_${crew}_${date}.${ext}`;
    }
    function parseNumber(v){
      const s = String(v ?? "").trim();
      if (!s) return null;
      const n = Number(s.replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function normalizeElevToMeters(v){
      const n = parseNumber(v);
      if (!Number.isFinite(n)) return null;
      return n > 1000 ? n / 100 : n;
    }
    function calcDeltaCm(fieldM, designM){
      if (!Number.isFinite(fieldM) || !Number.isFinite(designM)) return null;
      return (fieldM - designM) * 100;
    }
    function passFail(deltaCmVal, tolCm){
      if (!Number.isFinite(deltaCmVal)) return "N/A";
      return Math.abs(deltaCmVal) <= tolCm ? "PASS" : "FAIL";
    }
    function fmt(n, d=2){ if (!Number.isFinite(n)) return ""; return Number(n).toFixed(d); }
    function fmtDash(n, d=1){ if (!Number.isFinite(n)) return "—"; return Number(n).toFixed(d); }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // ---- Elements ----
    const areaSelect = document.getElementById("areaSelect");
    const tolLabel = document.getElementById("tolLabel");

    const jobNo = document.getElementById("jobNo");
    const jobDate = document.getElementById("jobDate");
    const community = document.getElementById("community");
    const address = document.getElementById("address");
    const lotBlockPlan = document.getElementById("lotBlockPlan");
    const crewChief = document.getElementById("crewChief");

    const sumPoints = document.getElementById("sumPoints");
    const sumFails = document.getElementById("sumFails");
    const sumWorst = document.getElementById("sumWorst");
    const sumPlanPts = document.getElementById("sumPlanPts");

    const btnSave = document.getElementById("btnSave");
    const btnReset = document.getElementById("btnReset");
    const btnPDF = document.getElementById("btnPDF");
    const btnShare = document.getElementById("btnShare");

    const planInput = document.getElementById("planInput");
    const btnClearPlan = document.getElementById("btnClearPlan");
    const btnClearMarkers = document.getElementById("btnClearMarkers");

    const planWrap = document.getElementById("planWrap");
    const planEmpty = document.getElementById("planEmpty");
    const planStage = document.getElementById("planStage");
    const planImg = document.getElementById("planImg");
    const planName = document.getElementById("planName");
    const planType = document.getElementById("planType");

    const planClickMode = document.getElementById("planClickMode");
    const autoSortPoints = document.getElementById("autoSortPoints");

    const elevBody = document.getElementById("elevBody");
    const btnAddRow = document.getElementById("btnAddRow");
    const btnRemoveSelected = document.getElementById("btnRemoveSelected");

    const exportHost = document.getElementById("exportHost");

    // ---- Storage ----
    function saveToStorage(showToast=false){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (showToast){
          btnSave.textContent = "Saved";
          setTimeout(() => btnSave.textContent = "Save", 900);
        }
      }catch(e){
        alert("Save failed (storage limit). Try removing the plan or clearing markers.");
      }
    }
    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return false;

        state.meta = Object.assign(state.meta, parsed.meta || {});
        state.elevRows = Array.isArray(parsed.elevRows) ? parsed.elevRows : [];
        state.plan = parsed.plan || null;
        state.markers = Array.isArray(parsed.markers) ? parsed.markers : [];
        return true;
      }catch(e){
        return false;
      }
    }

    // ---- Sorting logic ----
    // Keep non-numeric rows in their current relative order, numeric rows sorted ascending.
    function isNumericPointName(name){
      const s = String(name || "").trim();
      return /^\d+(\.\d+)?$/.test(s);
    }
    function sortElevRowsIfEnabled(){
      if (!autoSortPoints.checked) return;
      const nonNumeric = [];
      const numeric = [];

      for (const r of state.elevRows){
        if (isNumericPointName(r.pointName)) numeric.push(r);
        else nonNumeric.push(r);
      }
      numeric.sort((a,b) => parseFloat(a.pointName) - parseFloat(b.pointName));
      state.elevRows = [...nonNumeric, ...numeric];
    }

    // ---- Tolerance + summary ----
    function renderTolerance(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;
      tolLabel.textContent = `±${tol} cm`;
    }

    function renderSummary(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;

      let pointsChecked = 0;
      let fails = 0;
      let worstAbs = null;
      let worstSigned = null;

      for (const r of state.elevRows){
        const designM = normalizeElevToMeters(r.designElev);
        const fieldM  = normalizeElevToMeters(r.fieldElev);
        const dCm = calcDeltaCm(fieldM, designM);
        if (!Number.isFinite(dCm)) continue;

        pointsChecked++;
        if (Math.abs(dCm) > tol) fails++;

        const abs = Math.abs(dCm);
        if (worstAbs === null || abs > worstAbs){
          worstAbs = abs;
          worstSigned = dCm;
        }
      }

      sumPoints.textContent = String(pointsChecked);
      sumFails.textContent = String(fails);
      sumWorst.textContent = (worstSigned === null) ? "—" : fmtDash(worstSigned, 1);
      sumPlanPts.textContent = String(state.markers.length);
    }

    // ---- Elevation table ----
    function renderElevations(){
      sortElevRowsIfEnabled();
      const tol = tolByAreaCm[state.meta.area] ?? 15;

      elevBody.innerHTML = "";
      for (const row of state.elevRows){
        const designM = normalizeElevToMeters(row.designElev);
        const fieldM  = normalizeElevToMeters(row.fieldElev);
        const dCm     = calcDeltaCm(fieldM, designM);
        const status  = passFail(dCm, tol);

        const deltaClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");
        const statusClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");

        const tr = document.createElement("tr");
        tr.dataset.rowId = row.id;

        tr.innerHTML = `
          <td><input type="checkbox" class="rowSel" data-id="${row.id}"></td>
          <td>
            <input class="mini" data-k="pointName" data-id="${row.id}" value="${escapeHtml(row.pointName||"")}"
              placeholder="RMOW, TP, LMOW, 1, 2..." />
          </td>
          <td>
            <input class="mini" data-k="fieldElev" data-id="${row.id}" value="${escapeHtml(row.fieldElev||"")}"
              placeholder="Field Elev" inputmode="decimal" />
          </td>
          <td>
            <input class="mini" data-k="designElev" data-id="${row.id}" value="${escapeHtml(row.designElev||"")}"
              placeholder="Design Elev" inputmode="decimal" />
          </td>
          <td><span class="delta ${deltaClass}">${Number.isFinite(dCm) ? fmtDash(dCm,1) : "—"}</span></td>
          <td><span class="status ${statusClass}">${status}</span></td>
        `;
        elevBody.appendChild(tr);
      }

      renderSummary();
    }

    function updateComputedRow(rowId){
      const tr = elevBody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
      if (!tr) return;

      const tol = tolByAreaCm[state.meta.area] ?? 15;
      const row = state.elevRows.find(r => r.id === rowId);
      if (!row) return;

      const designM = normalizeElevToMeters(row.designElev);
      const fieldM  = normalizeElevToMeters(row.fieldElev);
      const dCm     = calcDeltaCm(fieldM, designM);
      const status  = passFail(dCm, tol);

      const deltaSpan = tr.querySelector(".delta");
      const statusSpan = tr.querySelector(".status");

      const deltaClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");
      const statusClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");

      deltaSpan.textContent = Number.isFinite(dCm) ? fmtDash(dCm,1) : "—";
      deltaSpan.className = `delta ${deltaClass}`;

      statusSpan.textContent = status;
      statusSpan.className = `status ${statusClass}`;

      renderSummary();
    }

    // ---- Plan upload + click markers ----
    async function fileToArrayBuffer(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onerror = () => reject(new Error("Read failed"));
        fr.onload = () => resolve(fr.result);
        fr.readAsArrayBuffer(file);
      });
    }

    function compressImageToDataUrl(file, maxDim=1800, quality=0.88){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onerror = () => reject(new Error("File read failed"));
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            const w = img.width;
            const h = img.height;
            const scale = Math.min(1, maxDim / Math.max(w, h));
            const cw = Math.round(w * scale);
            const ch = Math.round(h * scale);

            const canvas = document.createElement("canvas");
            canvas.width = cw;
            canvas.height = ch;
            const ctx = canvas.getContext("2d", { alpha:false });
            ctx.drawImage(img, 0, 0, cw, ch);

            resolve(canvas.toDataURL("image/jpeg", quality));
          };
          img.onerror = () => reject(new Error("Image load failed"));
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      });
    }

    async function renderPdfFirstPageToDataUrl(file, maxWidth=1800){
      if (!window.pdfjsLib) throw new Error("PDF.js not available");
      const ab = await fileToArrayBuffer(file);
      const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
      const page = await pdf.getPage(1);

      const viewport1 = page.getViewport({ scale: 1 });
      const scale = Math.min(3, maxWidth / viewport1.width);
      const viewport = page.getViewport({ scale });

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { alpha:false });
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);

      await page.render({ canvasContext: ctx, viewport }).promise;
      return canvas.toDataURL("image/jpeg", 0.90);
    }

    function renderPlan(){
      // clear any existing marker elements
      planStage.querySelectorAll(".marker").forEach(m => m.remove());

      if (!state.plan){
        planWrap.style.display = "none";
        planEmpty.style.display = "block";
        return;
      }

      planWrap.style.display = "block";
      planEmpty.style.display = "none";

      planImg.src = state.plan.dataUrl;
      planName.textContent = state.plan.name || "Plot plan";
      planType.textContent = state.plan.kind === "pdf" ? "PDF (page 1 rendered)" : "Image";

      // inject markers
      for (const mk of state.markers){
        const el = document.createElement("div");
        el.className = "marker";
        el.style.left = mk.xPct + "%";
        el.style.top = mk.yPct + "%";
        el.dataset.id = mk.id;
        el.title = "Click to edit/remove";
        el.textContent = mk.point;
        planStage.appendChild(el);
      }
      renderSummary();
    }

    function upsertPointRow(pointStr, fieldElevStr){
      const p = String(pointStr || "").trim();
      if (!p) return;

      // find existing point row (exact match)
      let row = state.elevRows.find(r => String(r.pointName||"").trim() === p);

      if (!row){
        row = { id: uid(), pointName: p, fieldElev: "", designElev: "" };
        state.elevRows.push(row);
      }

      // set field elevation
      row.fieldElev = String(fieldElevStr || "").trim();

      // sort + render table, but keep typing stable by rerendering only when we add new rows
      renderElevations();
      saveToStorage();
    }

    function promptPointAndElev(defaultPoint=""){
      const p = prompt("Point number (e.g., 1, 2, 12):", defaultPoint);
      if (p === null) return null;

      const pe = String(p).trim();
      if (!pe){
        alert("Point number is required.");
        return null;
      }

      const elev = prompt("Field elevation (e.g., 92.21 or 9221):", "");
      if (elev === null) return null;

      const ee = String(elev).trim();
      if (!ee){
        alert("Field elevation is required.");
        return null;
      }

      return { point: pe, fieldElev: ee };
    }

    function addMarkerAtClick(evt){
      if (!state.plan) return;
      if (!planClickMode.checked) return;

      const rect = planStage.getBoundingClientRect();
      const x = (evt.clientX - rect.left) / rect.width;
      const y = (evt.clientY - rect.top) / rect.height;

      // constrain
      const xPct = Math.max(0, Math.min(100, x * 100));
      const yPct = Math.max(0, Math.min(100, y * 100));

      const data = promptPointAndElev("");
      if (!data) return;

      // If marker for this point exists, move it + update elev
      const existing = state.markers.find(m => String(m.point).trim() === String(data.point).trim());
      if (existing){
        existing.xPct = xPct;
        existing.yPct = yPct;
        existing.fieldElev = data.fieldElev;
      } else {
        state.markers.push({
          id: uid(),
          xPct, yPct,
          point: data.point,
          fieldElev: data.fieldElev
        });
      }

      // update table
      upsertPointRow(data.point, data.fieldElev);

      // re-render markers
      renderPlan();
      saveToStorage();
    }

    function editOrRemoveMarker(markerId){
      const mk = state.markers.find(m => m.id === markerId);
      if (!mk) return;

      const action = prompt(`Marker ${mk.point}: type "edit" to change values, or "remove" to delete it.`, "edit");
      if (action === null) return;

      const a = action.trim().toLowerCase();
      if (a === "remove"){
        state.markers = state.markers.filter(m => m.id !== markerId);
        renderPlan();
        saveToStorage();
        return;
      }

      if (a === "edit"){
        const data = promptPointAndElev(mk.point);
        if (!data) return;

        // update marker point + elev
        mk.point = data.point;
        mk.fieldElev = data.fieldElev;

        // push to table
        upsertPointRow(data.point, data.fieldElev);

        renderPlan();
        saveToStorage();
      }
    }

    async function setPlotPlanFromFile(file){
      const isPdf = file.type === "application/pdf" || (file.name || "").toLowerCase().endsWith(".pdf");

      let dataUrl = "";
      let kind = "image";

      if (isPdf){
        kind = "pdf";
        dataUrl = await renderPdfFirstPageToDataUrl(file, 1800);
      } else if (file.type.startsWith("image/")){
        kind = "image";
        dataUrl = await compressImageToDataUrl(file, 1800, 0.88);
      } else {
        alert("Please upload an image or a PDF.");
        return;
      }

      state.plan = { name: file.name || "plot-plan", kind, dataUrl };

      // keep markers, but user can clear if new plan
      renderPlan();
      saveToStorage();
    }

    function clearPlan(){
      if (!state.plan) return;
      if (!confirm("Remove the attached plot plan?")) return;
      state.plan = null;
      renderPlan();
      saveToStorage();
    }

    function clearMarkers(){
      if (!state.markers.length) return;
      if (!confirm("Clear all markers from the plot plan?")) return;
      state.markers = [];
      renderPlan();
      saveToStorage();
    }

    // ---- PDF export + share ----
    function buildReportElement(){
      exportHost.innerHTML = "";
      const tol = tolByAreaCm[state.meta.area] ?? 15;

      const wrap = document.createElement("div");
      wrap.className = "report";

      wrap.innerHTML = `
        <div class="reportHeader">
          <div class="reportLogo"><img src="vista-geomatics.png" alt="Logo"/></div>
          <div>
            <p class="reportTitle">VISTA GEOMATICS, Grading Check Report</p>
            <p class="reportSub">Tolerance: ±${tol} cm</p>
          </div>
        </div>

        <div class="reportMeta">
          <div><b>Job Number:</b> ${escapeHtml(state.meta.jobNo || "")}</div>
          <div><b>Date:</b> ${escapeHtml(state.meta.jobDate || "")}</div>
          <div><b>Community:</b> ${escapeHtml(state.meta.community || "")}</div>
          <div><b>Address:</b> ${escapeHtml(state.meta.address || "")}</div>
          <div><b>Lot/Block/Plan:</b> ${escapeHtml(state.meta.lotBlockPlan || "")}</div>
          <div><b>Crew Chief:</b> ${escapeHtml(state.meta.crewChief || "")}</div>
        </div>
      `;

      // Plan page (with markers baked in)
      if (state.plan){
        const planPage = document.createElement("div");
        planPage.className = "pageBreak";
        planPage.innerHTML = `
          <div class="reportSectionTitle">Marked Up Plot Plan</div>
          <div class="planPrintWrap">
            <div class="planPrintStage" id="planPrintStage">
              <img src="${state.plan.dataUrl}" alt="${escapeHtml(state.plan.name)}" />
            </div>
            <div style="padding:8px 10px; font-size:11px; color:#334155; border-top:1px solid #e5edf7; background:#fafcff;">
              ${escapeHtml(state.plan.name)}
            </div>
          </div>
        `;
        wrap.appendChild(planPage);

        // add markers as absolutely positioned labels in percent coords
        const stage = planPage.querySelector("#planPrintStage");
        for (const mk of state.markers){
          const el = document.createElement("div");
          el.className = "planPrintMarker";
          el.style.left = mk.xPct + "%";
          el.style.top = mk.yPct + "%";
          el.textContent = mk.point;
          stage.appendChild(el);
        }
      }

      // Elevation table
      const elevTableTitle = document.createElement("div");
      elevTableTitle.className = "reportSectionTitle";
      elevTableTitle.textContent = "Elevation Comparison";
      wrap.appendChild(elevTableTitle);

      const tolCm = tolByAreaCm[state.meta.area] ?? 15;

      const elevTable = document.createElement("table");
      elevTable.className = "reportTable";
      elevTable.innerHTML = `
        <thead>
          <tr>
            <th>STA / Point</th>
            <th>Field Elev</th>
            <th>Design Elev</th>
            <th>Δ (cm)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${state.elevRows.map(r => {
            const designM = normalizeElevToMeters(r.designElev);
            const fieldM  = normalizeElevToMeters(r.fieldElev);
            const dCm     = calcDeltaCm(fieldM, designM);
            const status  = passFail(dCm, tolCm);
            const pill = status === "PASS" ? 'pillSmall ok' : (status === "FAIL" ? 'pillSmall bad' : 'pillSmall');
            return `
              <tr>
                <td>${escapeHtml(String(r.pointName||"").trim())}</td>
                <td>${escapeHtml(String(r.fieldElev||"").trim())}</td>
                <td>${escapeHtml(String(r.designElev||"").trim())}</td>
                <td>${escapeHtml(Number.isFinite(dCm) ? fmtDash(dCm,1) : "—")}</td>
                <td><span class="${pill}">${escapeHtml(status)}</span></td>
              </tr>
            `;
          }).join("")}
        </tbody>
      `;
      wrap.appendChild(elevTable);

      exportHost.appendChild(wrap);
      return wrap;
    }

    function waitImagesLoaded(container){
      const imgs = Array.from(container.querySelectorAll("img"));
      if (imgs.length === 0) return Promise.resolve();
      return Promise.all(imgs.map(img => {
        if (img.complete && img.naturalWidth > 0) return Promise.resolve();
        return new Promise(resolve => {
          const done = () => resolve();
          img.addEventListener("load", done, { once:true });
          img.addEventListener("error", done, { once:true });
        });
      })).then(() => undefined);
    }

    async function exportPDF(){
      if (typeof html2pdf === "undefined"){
        alert("PDF export library failed to load. Connect once and refresh.");
        return;
      }

      const reportEl = buildReportElement();
      await waitImagesLoaded(reportEl);

      const filename = defaultFileName("pdf");

      btnPDF.textContent = "Exporting...";
      btnPDF.disabled = true;

      try{
        await html2pdf()
          .set({
            margin: [10, 10, 10, 10],
            filename,
            image: { type: "jpeg", quality: 0.95 },
            html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
            jsPDF: { unit: "mm", format: "letter", orientation: "portrait" },
            pagebreak: { mode: ["css", "legacy"] }
          })
          .from(reportEl)
          .save();
      } finally{
        btnPDF.textContent = "Export PDF";
        btnPDF.disabled = false;
        exportHost.innerHTML = "";
      }
    }

    async function sharePDF(){
      if (typeof html2pdf === "undefined"){
        alert("Share requires the PDF export library (online once to load).");
        return;
      }

      const reportEl = buildReportElement();
      await waitImagesLoaded(reportEl);

      const filename = defaultFileName("pdf");

      btnShare.textContent = "Preparing...";
      btnShare.disabled = true;

      try{
        const opt = {
          margin: [10, 10, 10, 10],
          image: { type: "jpeg", quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
          jsPDF: { unit: "mm", format: "letter", orientation: "portrait" },
          pagebreak: { mode: ["css", "legacy"] }
        };

        const worker = html2pdf().set(opt).from(reportEl);
        const pdfBlob = await worker.outputPdf("blob");
        const file = new File([pdfBlob], filename, { type: "application/pdf" });

        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({
            title: "Vista Geomatics – Grading Check",
            text: "Grading check report attached.",
            files: [file]
          });
        } else {
          await html2pdf().set({ ...opt, filename }).from(reportEl).save();
          alert("Share isn't available in this browser, the PDF was downloaded instead.");
        }
      } catch (e) {
        // user can cancel share
      } finally{
        btnShare.textContent = "Share PDF";
        btnShare.disabled = false;
        exportHost.innerHTML = "";
      }
    }

    // ---- Defaults ----
    function initDefaults(){
      if (state.elevRows.length === 0){
        // setup row + starter points
        state.elevRows.push({ id: uid(), pointName: "RMOW", fieldElev: "", designElev: "" });
        state.elevRows.push({ id: uid(), pointName: "1", fieldElev: "", designElev: "" });
        state.elevRows.push({ id: uid(), pointName: "2", fieldElev: "", designElev: "" });
        state.elevRows.push({ id: uid(), pointName: "3", fieldElev: "", designElev: "" });
      }
    }

    function syncMetaToUI(){
      areaSelect.value = state.meta.area || "calgary";
      jobNo.value = state.meta.jobNo || "";
      jobDate.value = state.meta.jobDate || "";
      community.value = state.meta.community || "";
      address.value = state.meta.address || "";
      lotBlockPlan.value = state.meta.lotBlockPlan || "";
      crewChief.value = state.meta.crewChief || "";
    }

    // ---- Events ----
    areaSelect.addEventListener("change", () => {
      state.meta.area = areaSelect.value;
      renderTolerance();
      // update computed cells without rerendering inputs
      renderElevations();
      saveToStorage();
    });

    function bindMetaInput(el, key){
      el.addEventListener("input", () => {
        state.meta[key] = el.value;
        saveToStorage();
      });
    }
    bindMetaInput(jobNo, "jobNo");
    bindMetaInput(jobDate, "jobDate");
    bindMetaInput(community, "community");
    bindMetaInput(address, "address");
    bindMetaInput(lotBlockPlan, "lotBlockPlan");
    bindMetaInput(crewChief, "crewChief");

    elevBody.addEventListener("input", (e) => {
      const t = e.target;
      if (!t?.dataset?.id) return;

      const id = t.dataset.id;
      const k = t.dataset.k;
      const row = state.elevRows.find(r => r.id === id);
      if (!row) return;

      row[k] = t.value;

      // only rerender when pointName changes AND autosort enabled
      if (k === "pointName" && autoSortPoints.checked){
        renderElevations();
      } else {
        updateComputedRow(id);
      }
      saveToStorage();
    });

    btnAddRow.addEventListener("click", () => {
      state.elevRows.push({ id: uid(), pointName: "", fieldElev: "", designElev: "" });
      renderElevations();
      saveToStorage();
    });

    btnRemoveSelected.addEventListener("click", () => {
      const checks = Array.from(document.querySelectorAll(".rowSel:checked"));
      const ids = new Set(checks.map(c => c.dataset.id));
      state.elevRows = state.elevRows.filter(r => !ids.has(r.id));
      renderElevations();
      saveToStorage();
    });

    btnSave.addEventListener("click", () => saveToStorage(true));

    btnReset.addEventListener("click", () => {
      if (!confirm("Clear this grading check from this device?")) return;
      localStorage.removeItem(STORAGE_KEY);

      state.meta = { area:"calgary", jobNo:"", jobDate:"", community:"", address:"", lotBlockPlan:"", crewChief:"" };
      state.elevRows = [];
      state.plan = null;
      state.markers = [];

      initDefaults();
      if (!state.meta.jobDate) state.meta.jobDate = todayISO();
      syncMetaToUI();

      renderTolerance();
      renderElevations();
      renderPlan();
      saveToStorage();
    });

    btnPDF.addEventListener("click", () => exportPDF());
    btnShare.addEventListener("click", () => sharePDF());

    // Plan upload
    planInput.addEventListener("change", async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try{
        await setPlotPlanFromFile(f);
      }catch(err){
        alert("Could not process that file. Try a smaller PDF or export it flattened.");
      }
      planInput.value = "";
    });

    btnClearPlan.addEventListener("click", () => clearPlan());
    btnClearMarkers.addEventListener("click", () => clearMarkers());

    // Click-to-add marker
    planStage.addEventListener("click", (e) => {
      // If clicking on an existing marker, let the marker click handler take it
      const mk = e.target.closest(".marker");
      if (mk) return;
      addMarkerAtClick(e);
    });

    // Marker edit/remove
    planStage.addEventListener("click", (e) => {
      const mk = e.target.closest(".marker");
      if (!mk) return;
      editOrRemoveMarker(mk.dataset.id);
    });

    // ---- Boot ----
    function loadAndInit(){
      loadFromStorage();
      if (!state.meta.jobDate) state.meta.jobDate = todayISO();

      initDefaults();
      syncMetaToUI();

      renderTolerance();
      renderElevations();
      renderPlan();

      saveToStorage();
    }
    loadAndInit();
  </script>
</body>
</html>
