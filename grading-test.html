<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VistaGeomatics – Grading Check</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --vista-blue:#165f7d;
      --vista-blue-light:#2a7fa3;
      --vista-blue-dark:#0b3045;

      --bg-body:#eef3f9;
      --bg-card:#ffffff;
      --border-soft:#d6e2f0;

      --text-main:#101827;
      --text-muted:#5b6777;

      --ok:#15803d;
      --bad:#b91c1c;

      --shadow: 0 10px 30px rgba(2, 10, 20, 0.08);
      --radius: 16px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:"Inter", sans-serif;
      background: radial-gradient(circle at top, #f4fbff 0%, var(--bg-body) 55%, #e9f1fb 100%);
      color:var(--text-main);
    }

    .wrap{
      max-width: 1180px;
      margin: 20px auto 60px;
      padding: 0 16px;
    }

    .topbar{
      background: linear-gradient(135deg, var(--vista-blue-dark), var(--vista-blue));
      color:#fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar-inner{
      display:flex;
      align-items:center;
      gap:16px;
      padding: 16px 18px;
      flex-wrap:wrap;
    }

    .logo{
      width: 54px;
      height: 54px;
      border-radius: 12px;
      background: rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logo img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 8px;
    }

    .brand{
      flex:1 1 auto;
      min-width: 220px;
    }
    .brand .title{
      font-family:"Montserrat", sans-serif;
      font-weight:700;
      letter-spacing:0.5px;
      font-size: 18px;
      margin:0;
      line-height:1.2;
    }
    .brand .subtitle{
      margin:4px 0 0;
      opacity:0.9;
      font-size: 13px;
    }

    .pill{
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.22);
      padding:10px 12px;
      border-radius: 999px;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .pill b{ font-weight:700; }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .pill{ width:100%; justify-content:space-between; }
    }

    .card{
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-h{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-soft);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      background: linear-gradient(180deg, #ffffff, #fbfdff);
      flex-wrap: wrap;
    }
    .card-h h2{
      margin:0;
      font-size: 14px;
      letter-spacing:0.2px;
    }
    .card-b{
      padding: 14px 16px 16px;
    }

    .formgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){
      .formgrid{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    input, select, textarea{
      width:100%;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      outline:none;
      background:#fff;
      color: var(--text-main);
    }
    textarea{ min-height: 86px; resize: vertical; }

    .btnbar{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.0);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight:600;
      cursor:pointer;
      transition: transform 0.05s ease, opacity 0.15s ease, background 0.15s ease;
      user-select:none;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, var(--vista-blue), var(--vista-blue-light));
      color:#fff;
    }
    .btn.ghost{
      background: #f4f8fc;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
    }
    .btn.danger{
      background: #fff1f2;
      border: 1px solid #fecdd3;
      color: var(--bad);
    }

    .hint{
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      line-height: 1.35;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border: 1px solid var(--border-soft);
      border-radius: 14px;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--text-muted);
      padding: 10px 10px;
      background: #f6fafc;
      border-bottom: 1px solid var(--border-soft);
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--border-soft);
      vertical-align: middle;
      font-size: 14px;
    }
    tbody tr:last-child td{ border-bottom: none; }

    td .mini{
      padding: 8px 8px;
      border-radius: 10px;
      font-size: 13px;
    }

    .status{
      font-weight: 700;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-block;
      border: 1px solid transparent;
    }
    .status.ok{ color: var(--ok); background: #eaf7ee; border-color: #c7ecd2; }
    .status.bad{ color: var(--bad); background: #fff1f2; border-color: #fecdd3; }
    .status.na{ color: #475569; background: #eef2f7; border-color: #d6dee9; }

    .delta{ font-weight: 800; letter-spacing:0.1px; }
    .delta.ok{ color: var(--ok); }
    .delta.bad{ color: var(--bad); }
    .delta.na{ color:#475569; }

    .summary{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
      padding: 12px 12px;
      border: 1px dashed var(--border-soft);
      border-radius: 14px;
      background: #fbfdff;
    }
    .summary .k{ font-size: 12px; color: var(--text-muted); }
    .summary .v{ font-weight: 800; font-size: 14px; }

    /* Photos */
    .thumbGrid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
    }
    @media (max-width: 980px){
      .thumbGrid{ grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 520px){
      .thumbGrid{ grid-template-columns: repeat(3, 1fr); }
    }
    .thumb{
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      overflow:hidden;
      background:#fff;
      position: relative;
      aspect-ratio: 1 / 1;
      box-shadow: 0 6px 16px rgba(2,10,20,0.06);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .thumb .x{
      position:absolute;
      top:6px;
      right:6px;
      width:28px;
      height:28px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.85);
      background: rgba(0,0,0,0.42);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .thumb .cap{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      padding:6px 8px;
      font-size:11px;
      color:#fff;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.65));
      line-height:1.2;
      min-height: 30px;
    }

    /* Notes templates */
    .templateGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 680px){
      .templateGrid{ grid-template-columns: 1fr; }
    }
    .checkRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 10px;
      border: 1px solid var(--border-soft);
      border-radius: 12px;
      background:#fbfdff;
    }
    .checkRow input{ width:auto; margin-top: 2px; }
    .checkRow .t{
      font-size: 13px;
      line-height: 1.25;
    }
    .checkRow .t b{ display:block; font-size: 12px; color: var(--text-muted); margin-bottom: 2px; }

    /* Chips */
    .chipBar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 6px;
    }
    .chip{
      border: 1px solid var(--border-soft);
      background:#f6fafc;
      color: #0b3045;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{ transform: translateY(1px); }

    /* Print photos */
    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; margin:0; padding:0; }
      .no-print, .btnbar, .hint{ display:none !important; }
      .card{ box-shadow:none; }
      .topbar{ border-radius:0; }
      .printPhotos{ display:block !important; }

      .printPhotos h3{
        margin: 18px 0 10px;
        font-family:"Montserrat", sans-serif;
        font-size: 14px;
        color:#0b3045;
      }
      .photoPage{ page-break-before: always; }
      .photoGridPrint{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .photoBig{
        border: 1px solid #d6dee9;
        border-radius: 12px;
        overflow:hidden;
      }
      .photoBig img{
        width:100%;
        height: auto;
        display:block;
      }
      .photoBig .label{
        padding: 8px 10px;
        font-size: 11px;
        color:#334155;
        border-top: 1px solid #e5edf7;
        background:#fafcff;
      }
    }
    .printPhotos{ display:none; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbar-inner">
        <div class="logo" title="Vista Geomatics">
          <img src="vista-geomatics.png" alt="Vista Geomatics Logo" />
        </div>

        <div class="brand">
          <p class="title">VISTA GEOMATICS</p>
          <p class="subtitle">Survey Grading Check, Plot Plan vs Field, Elevations, Slopes, Photos</p>
        </div>

        <div class="pill">
          <span><b>Area</b></span>
          <select id="areaSelect" style="width:auto; background: rgba(255,255,255,0.95); color:#0b3045; border:none; border-radius:999px; padding:8px 10px;">
            <option value="calgary">Calgary</option>
            <option value="chestermere">Chestermere</option>
            <option value="airdrie">Airdrie</option>
          </select>
        </div>

        <div class="pill">
          <span><b>Tolerance</b></span>
          <span id="tolLabel">±15 cm</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="card-h">
          <h2>Job Details</h2>
          <div class="btnbar no-print">
            <button class="btn ghost" id="btnSave" type="button">Save</button>
            <button class="btn ghost" id="btnReset" type="button">Clear</button>
            <button class="btn primary" id="btnDownload" type="button">Download</button>
            <button class="btn primary" id="btnShare" type="button">Share</button>
          </div>
        </div>
        <div class="card-b">
          <div class="formgrid">
            <div>
              <label>Job Number</label>
              <input id="jobNo" placeholder="e.g., 25-0123" autocomplete="off" />
            </div>
            <div>
              <label>Date</label>
              <input id="jobDate" type="date" />
            </div>
            <div>
              <label>Community / Subdivision</label>
              <input id="community" placeholder="e.g., Cornerstone" autocomplete="off" />
            </div>
            <div>
              <label>Address</label>
              <input id="address" placeholder="e.g., 2053–2055 Cornerstone Blvd NE" autocomplete="off" />
            </div>
            <div>
              <label>Lot / Block / Plan</label>
              <input id="lotBlockPlan" placeholder="e.g., Lot 12, Block 3, Plan ____" autocomplete="off" />
            </div>
            <div>
              <label>Crew Chief</label>
              <input id="crewChief" placeholder="Name" autocomplete="off" />
            </div>
          </div>

          <div class="summary" style="margin-top:14px;">
            <div>
              <div class="k">Points Checked</div>
              <div class="v" id="sumPoints">0</div>
            </div>
            <div>
              <div class="k">Fails</div>
              <div class="v" id="sumFails">0</div>
            </div>
            <div>
              <div class="k">Worst Δ (cm)</div>
              <div class="v" id="sumWorst">—</div>
            </div>
            <div>
              <div class="k">Photos</div>
              <div class="v" id="sumPhotos">0</div>
            </div>
          </div>

          <div class="hint">
            Download/Share creates a self-contained report file named using Job Number, Crew Chief, and today’s date.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <h2>Office Summary</h2>
          <div class="btnbar no-print">
            <button class="btn ghost" id="btnGenSummary" type="button">Generate</button>
            <button class="btn primary" id="btnCopySummary" type="button">Copy</button>
            <button class="btn ghost" id="btnPrint" type="button">Print / PDF</button>
          </div>
        </div>
        <div class="card-b">
          <label>Auto-generated summary for office & drafters</label>
          <textarea id="officeSummary" placeholder="Click Generate to build a consistent summary..."></textarea>
          <div class="hint">
            Generated from tolerance selection, fails, worst deltas, slopes, templates, notes, and photo count.
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Notes (Fast, Consistent)</h2>
          <div class="btnbar no-print">
            <button class="btn ghost" id="btnAddDefaults" type="button">Add Default Points</button>
          </div>
        </div>
        <div class="card-b">
          <label>General Notes / Crew Notes</label>
          <textarea id="notes" placeholder="Optional free text, templates below will help keep notes consistent..."></textarea>

          <div class="hint" style="margin-top:10px;">
            Templates below build consistent, office-ready notes.
          </div>

          <div id="templateGrid" class="templateGrid"></div>

          <div class="hint">
            Tip: In the table, use one-click chips for point notes (Low/High/Regrade/etc.).
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Site Photos</h2>
          <div class="btnbar no-print">
            <label class="btn ghost" style="cursor:pointer;">
              Add Photos
              <input id="photoInput" type="file" accept="image/*" multiple style="display:none;">
            </label>
            <button class="btn danger" id="btnClearPhotos" type="button">Clear Photos</button>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-top:0;">
            Thumbnails show here. Print / PDF includes larger photos, 4 per page. Click a thumbnail to add a caption.
          </div>
          <div style="margin-top:12px;">
            <div id="thumbGrid" class="thumbGrid"></div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Elevation Comparison (Plot Plan vs Field)</h2>
          <div class="btnbar no-print">
            <button class="btn ghost" id="btnAddRow" type="button">Add Row</button>
            <button class="btn danger" id="btnRemoveSelected" type="button">Remove Selected</button>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-top:0;">
            Δ (cm) = (Field − Design) × 100. Status uses the selected area tolerance.
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table id="elevTable">
              <thead>
                <tr>
                  <th style="width:44px;" class="no-print">Sel</th>
                  <th style="min-width:180px;">STA / Point</th>
                  <th style="min-width:160px;">Design Elev</th>
                  <th style="min-width:160px;">Field Elev</th>
                  <th style="min-width:120px;">Δ (cm)</th>
                  <th style="min-width:110px;">Status</th>
                  <th style="min-width:280px;">Point Notes (use chips)</th>
                </tr>
              </thead>
              <tbody id="elevBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="card-h">
          <h2>Slope Calculator (Between Points)</h2>
          <div class="btnbar no-print">
            <button class="btn ghost" id="btnAddSlope" type="button">Add Slope Row</button>
            <button class="btn danger" id="btnRemoveSlopeSelected" type="button">Remove Selected</button>
          </div>
        </div>
        <div class="card-b">
          <div class="hint" style="margin-top:0;">
            Slope % = (Rise / Run) × 100. Rise uses Design elevs and Field elevs from the elevation table.
          </div>

          <div style="margin-top:12px; overflow:auto;">
            <table id="slopeTable">
              <thead>
                <tr>
                  <th style="width:44px;" class="no-print">Sel</th>
                  <th style="min-width:220px;">Segment</th>
                  <th style="min-width:180px;">From Point</th>
                  <th style="min-width:180px;">To Point</th>
                  <th style="min-width:140px;">Distance (m)</th>
                  <th style="min-width:140px;">Design Slope %</th>
                  <th style="min-width:140px;">Field Slope %</th>
                  <th style="min-width:120px;">Δ Slope %</th>
                </tr>
              </thead>
              <tbody id="slopeBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <div id="printPhotos" class="printPhotos"></div>
  </div>

  <script>
    const STORAGE_KEY = "vista_grading_check_v4";

    const tolByAreaCm = { calgary: 15, chestermere: 15, airdrie: 10 };

    const NOTE_CHIPS = [
      "Low, requires fill",
      "High, requires cut",
      "Regrade and shape to drain",
      "Swale not defined, re-shape",
      "Tie-in required, verify match",
      "Hold, builder review required",
      "Recheck after regrade",
      "As-built matches design"
    ];

    const NOTE_TEMPLATES = [
      { id:"tpl_access", title:"Access / Site Condition", text:"Site accessible, no major obstructions impacting shots." },
      { id:"tpl_obstruct", title:"Access / Site Condition", text:"Obstructions present on site, some shots limited, see photos and point notes." },
      { id:"tpl_snow", title:"Weather / Surface", text:"Snow/ice present, measurements taken with caution and limited surface visibility in areas." },
      { id:"tpl_wet", title:"Weather / Surface", text:"Soft/wet soil conditions observed, expect potential settlement/adjustment after compaction." },
      { id:"tpl_equip", title:"Construction Activity", text:"Builder equipment/materials on site during survey, access constraints noted." },
      { id:"tpl_recheck", title:"Follow-up", text:"Recheck required after regrade/adjustment, see out-of-tolerance items." },
      { id:"tpl_hold", title:"Hold", text:"Hold pending builder correction/confirmation, office to review before drafting." }
    ];

    const state = {
      meta: {
        area: "calgary",
        jobNo: "",
        jobDate: "",
        community: "",
        address: "",
        lotBlockPlan: "",
        crewChief: "",
        notes: "",
        templates: {}
      },
      elevRows: [],
      slopeRows: [],
      photos: []
    };

    // ---------- Helpers ----------
    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
    function fmt(n, decimals=2){ if (!Number.isFinite(n)) return "—"; return Number(n).toFixed(decimals); }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function normalizeElevToMeters(v){
      const s = String(v ?? "").trim();
      if (!s) return null;
      const n = Number(s.replace(",", "."));
      if (!Number.isFinite(n)) return null;
      return n > 1000 ? n / 100 : n; // 9221 -> 92.21 support
    }
    function calcDeltaCm(fieldM, designM){
      if (!Number.isFinite(fieldM) || !Number.isFinite(designM)) return null;
      return (fieldM - designM) * 100;
    }
    function passFail(deltaCmVal, tolCm){
      if (!Number.isFinite(deltaCmVal)) return "N/A";
      return Math.abs(deltaCmVal) <= tolCm ? "PASS" : "FAIL";
    }
    function slopePercent(elevFromM, elevToM, runM){
      if (!Number.isFinite(elevFromM) || !Number.isFinite(elevToM) || !Number.isFinite(runM) || runM <= 0) return null;
      return ((elevToM - elevFromM) / runM) * 100;
    }

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function safeName(s){
      return String(s ?? "")
        .trim()
        .replace(/[\\/:*?"<>|]+/g, "")
        .replace(/\s+/g, " ")
        .replaceAll(" ", "_")
        .slice(0, 80) || "Grading_Check";
    }

    function defaultFileName(ext){
      const job = safeName(state.meta.jobNo || "Job");
      const crew = safeName(state.meta.crewChief || "Crew");
      const date = todayISO();
      return `${job}_${crew}_${date}.${ext}`;
    }

    function areaLabel(){
      const v = state.meta.area;
      return v ? (v.charAt(0).toUpperCase() + v.slice(1)) : "Area";
    }

    // ---------- Elements ----------
    const areaSelect = document.getElementById("areaSelect");
    const tolLabel = document.getElementById("tolLabel");

    const jobNo = document.getElementById("jobNo");
    const jobDate = document.getElementById("jobDate");
    const community = document.getElementById("community");
    const address = document.getElementById("address");
    const lotBlockPlan = document.getElementById("lotBlockPlan");
    const crewChief = document.getElementById("crewChief");
    const notes = document.getElementById("notes");
    const officeSummary = document.getElementById("officeSummary");

    const elevBody = document.getElementById("elevBody");
    const slopeBody = document.getElementById("slopeBody");

    const sumPoints = document.getElementById("sumPoints");
    const sumFails = document.getElementById("sumFails");
    const sumWorst = document.getElementById("sumWorst");
    const sumPhotos = document.getElementById("sumPhotos");

    const btnAddRow = document.getElementById("btnAddRow");
    const btnRemoveSelected = document.getElementById("btnRemoveSelected");
    const btnAddDefaults = document.getElementById("btnAddDefaults");
    const btnAddSlope = document.getElementById("btnAddSlope");
    const btnRemoveSlopeSelected = document.getElementById("btnRemoveSlopeSelected");

    const btnSave = document.getElementById("btnSave");
    const btnReset = document.getElementById("btnReset");
    const btnDownload = document.getElementById("btnDownload");
    const btnShare = document.getElementById("btnShare");
    const btnPrint = document.getElementById("btnPrint");

    const btnGenSummary = document.getElementById("btnGenSummary");
    const btnCopySummary = document.getElementById("btnCopySummary");

    const templateGrid = document.getElementById("templateGrid");

    const photoInput = document.getElementById("photoInput");
    const btnClearPhotos = document.getElementById("btnClearPhotos");
    const thumbGrid = document.getElementById("thumbGrid");
    const printPhotos = document.getElementById("printPhotos");

    // ---------- Rendering ----------
    function renderTolerance(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;
      tolLabel.textContent = `±${tol} cm`;
    }

    function pointNameOptions(){
      const names = state.elevRows.map(r => (r.pointName || "").trim()).filter(Boolean);
      const uniq = [];
      const seen = new Set();
      for (const n of names){
        if (!seen.has(n)){ uniq.push(n); seen.add(n); }
      }
      return uniq;
    }

    function renderTemplates(){
      templateGrid.innerHTML = "";
      for (const t of NOTE_TEMPLATES){
        const checked = !!state.meta.templates[t.id];
        const div = document.createElement("div");
        div.className = "checkRow";
        div.innerHTML = `
          <input type="checkbox" data-tpl="${t.id}" ${checked ? "checked":""} />
          <div class="t">
            <b>${escapeHtml(t.title)}</b>
            ${escapeHtml(t.text)}
          </div>
        `;
        templateGrid.appendChild(div);
      }
    }

    function applyTemplatesToNotes(){
      const chosen = NOTE_TEMPLATES
        .filter(t => state.meta.templates[t.id])
        .map(t => t.text);

      const manual = (notes.value || "").trim();
      const manualLines = manual ? manual.split("\n").map(s => s.trim()).filter(Boolean) : [];

      const all = [...manualLines];
      for (const line of chosen){
        if (!all.includes(line)) all.push(line);
      }

      notes.value = all.join("\n");
      state.meta.notes = notes.value;
    }

    function renderElevations(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;
      elevBody.innerHTML = "";

      for (const row of state.elevRows){
        const tr = document.createElement("tr");
        tr.dataset.rowId = row.id;

        const designM = normalizeElevToMeters(row.designElev);
        const fieldM  = normalizeElevToMeters(row.fieldElev);
        const dCm     = calcDeltaCm(fieldM, designM);
        const status  = passFail(dCm, tol);

        const deltaClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");
        const statusClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");

        const chipsHtml = NOTE_CHIPS.map(ch =>
          `<span class="chip" data-action="chip" data-id="${row.id}" data-chip="${escapeHtml(ch)}">${escapeHtml(ch)}</span>`
        ).join("");

        tr.innerHTML = `
          <td class="no-print"><input type="checkbox" data-id="${row.id}" class="rowSel" /></td>
          <td>
            <input class="mini" value="${escapeHtml(row.pointName)}"
              placeholder="e.g., ROW, FL, SWALE..."
              data-k="pointName" data-id="${row.id}" />
          </td>
          <td>
            <input class="mini" value="${escapeHtml(row.designElev)}"
              placeholder="Design elev"
              inputmode="decimal"
              data-k="designElev" data-id="${row.id}" />
          </td>
          <td>
            <input class="mini" value="${escapeHtml(row.fieldElev)}"
              placeholder="Field elev"
              inputmode="decimal"
              data-k="fieldElev" data-id="${row.id}" />
          </td>
          <td>
            <span class="delta ${deltaClass}" data-role="delta">${Number.isFinite(dCm) ? fmt(dCm, 1) : "—"}</span>
          </td>
          <td>
            <span class="status ${statusClass}" data-role="status">${status}</span>
          </td>
          <td>
            <input class="mini" value="${escapeHtml(row.note)}"
              placeholder="Point note (or click chips)"
              data-k="note" data-id="${row.id}" />
            <div class="chipBar no-print">${chipsHtml}</div>
          </td>
        `;
        elevBody.appendChild(tr);
      }

      renderSlopes(true);
      renderSummary();
    }

    function updateElevationComputed(rowId){
      const tol = tolByAreaCm[state.meta.area] ?? 15;
      const row = state.elevRows.find(r => r.id === rowId);
      const tr = elevBody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
      if (!row || !tr) return;

      const designM = normalizeElevToMeters(row.designElev);
      const fieldM  = normalizeElevToMeters(row.fieldElev);
      const dCm     = calcDeltaCm(fieldM, designM);
      const status  = passFail(dCm, tol);

      const deltaEl = tr.querySelector('[data-role="delta"]');
      const statusEl = tr.querySelector('[data-role="status"]');

      const deltaClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");
      const statusClass = status === "PASS" ? "ok" : (status === "FAIL" ? "bad" : "na");

      if (deltaEl){
        deltaEl.textContent = Number.isFinite(dCm) ? fmt(dCm, 1) : "—";
        deltaEl.className = `delta ${deltaClass}`;
      }
      if (statusEl){
        statusEl.textContent = status;
        statusEl.className = `status ${statusClass}`;
      }

      renderSummary();
      updateAllSlopeComputed();
    }

    function pointSelectHtml(rowId, key, current, options){
      const safeCurrent = (current || "").trim();
      const opts = options.map(n => {
        const sel = n === safeCurrent ? "selected" : "";
        return `<option value="${escapeHtml(n)}" ${sel}>${escapeHtml(n)}</option>`;
      }).join("");

      return `
        <select class="mini" data-k="${key}" data-id="${rowId}" data-type="slope">
          <option value="">Select…</option>
          ${opts}
        </select>
      `;
    }

    function renderSlopes(rebuild=false){
      const options = pointNameOptions();
      if (rebuild){
        slopeBody.innerHTML = "";
        for (const row of state.slopeRows){
          const tr = document.createElement("tr");
          tr.dataset.rowId = row.id;

          tr.innerHTML = `
            <td class="no-print"><input type="checkbox" data-id="${row.id}" class="slopeSel" /></td>
            <td><input class="mini" value="${escapeHtml(row.segment)}" placeholder="e.g., Front swale, Driveway..." data-k="segment" data-id="${row.id}" data-type="slope" /></td>
            <td>${pointSelectHtml(row.id, "fromPoint", row.fromPoint, options)}</td>
            <td>${pointSelectHtml(row.id, "toPoint", row.toPoint, options)}</td>
            <td><input class="mini" value="${escapeHtml(row.distanceM)}" placeholder="Run (m)" inputmode="decimal" data-k="distanceM" data-id="${row.id}" data-type="slope" /></td>
            <td><span class="delta na" data-role="designSlope">—</span></td>
            <td><span class="delta na" data-role="fieldSlope">—</span></td>
            <td><span class="delta na" data-role="deltaSlope">—</span></td>
          `;
          slopeBody.appendChild(tr);
        }
      }
      updateAllSlopeComputed();
    }

    function updateAllSlopeComputed(){
      for (const row of state.slopeRows) updateSlopeComputed(row.id);
    }

    function updateSlopeComputed(rowId){
      const row = state.slopeRows.find(r => r.id === rowId);
      const tr = slopeBody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
      if (!row || !tr) return;

      const from = state.elevRows.find(r => (r.pointName || "").trim() === (row.fromPoint || "").trim());
      const to   = state.elevRows.find(r => (r.pointName || "").trim() === (row.toPoint || "").trim());

      const runM = Number(String(row.distanceM || "").trim().replace(",", "."));

      const designFromM = normalizeElevToMeters(from?.designElev);
      const designToM   = normalizeElevToMeters(to?.designElev);
      const fieldFromM  = normalizeElevToMeters(from?.fieldElev);
      const fieldToM    = normalizeElevToMeters(to?.fieldElev);

      const designSlope = slopePercent(designFromM, designToM, runM);
      const fieldSlope  = slopePercent(fieldFromM, fieldToM, runM);
      const deltaSlope  = (Number.isFinite(designSlope) && Number.isFinite(fieldSlope)) ? (fieldSlope - designSlope) : null;

      tr.querySelector('[data-role="designSlope"]').textContent = Number.isFinite(designSlope) ? fmt(designSlope, 2) : "—";
      tr.querySelector('[data-role="fieldSlope"]').textContent  = Number.isFinite(fieldSlope)  ? fmt(fieldSlope, 2)  : "—";
      tr.querySelector('[data-role="deltaSlope"]').textContent  = Number.isFinite(deltaSlope)  ? fmt(deltaSlope, 2)  : "—";
    }

    function renderSummary(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;

      let pointsChecked = 0;
      let fails = 0;
      let worstAbs = null;
      let worstSigned = null;

      for (const r of state.elevRows){
        const designM = normalizeElevToMeters(r.designElev);
        const fieldM  = normalizeElevToMeters(r.fieldElev);
        const dCm = calcDeltaCm(fieldM, designM);
        if (!Number.isFinite(dCm)) continue;

        pointsChecked++;
        if (Math.abs(dCm) > tol) fails++;

        const abs = Math.abs(dCm);
        if (worstAbs === null || abs > worstAbs){
          worstAbs = abs;
          worstSigned = dCm;
        }
      }

      sumPoints.textContent = String(pointsChecked);
      sumFails.textContent = String(fails);
      sumWorst.textContent = (worstSigned === null) ? "—" : fmt(worstSigned, 1);
      sumPhotos.textContent = String(state.photos.length);
    }

    // ---------- Photos ----------
    function renderThumbs(){
      thumbGrid.innerHTML = "";
      for (const p of state.photos){
        const div = document.createElement("div");
        div.className = "thumb";
        div.dataset.pid = p.id;

        const cap = p.caption ? p.caption : p.name;

        div.innerHTML = `
          <img src="${p.dataUrl}" alt="${escapeHtml(p.name)}" />
          <div class="x" title="Remove" data-action="remove">×</div>
          <div class="cap">${escapeHtml(cap || "")}</div>
        `;
        thumbGrid.appendChild(div);
      }
      renderSummary();
    }

    function compressImageToDataUrl(file, maxDim=1600, quality=0.82){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onerror = () => reject(new Error("File read failed"));
        fr.onload = () => {
          const img = new Image();
          img.onload = () => {
            const w = img.width;
            const h = img.height;
            const scale = Math.min(1, maxDim / Math.max(w, h));
            const cw = Math.round(w * scale);
            const ch = Math.round(h * scale);

            const canvas = document.createElement("canvas");
            canvas.width = cw;
            canvas.height = ch;
            const ctx = canvas.getContext("2d", { alpha:false });
            ctx.drawImage(img, 0, 0, cw, ch);

            const out = canvas.toDataURL("image/jpeg", quality);
            resolve(out);
          };
          img.onerror = () => reject(new Error("Image load failed"));
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      });
    }

    async function addPhotosFromFiles(fileList){
      const files = Array.from(fileList || []);
      for (const f of files){
        if (!f.type.startsWith("image/")) continue;
        try{
          const dataUrl = await compressImageToDataUrl(f, 1600, 0.82);
          state.photos.push({
            id: uid(),
            name: f.name || "photo",
            dataUrl,
            caption: "",
            ts: Date.now()
          });
        }catch(e){
          console.warn("Photo add failed:", e);
        }
      }
      renderThumbs();
      saveToStorage();
    }

    function removePhoto(id){
      state.photos = state.photos.filter(p => p.id !== id);
      renderThumbs();
      saveToStorage();
    }

    function clearPhotos(){
      if (!confirm("Remove all photos from this report?")) return;
      state.photos = [];
      renderThumbs();
      saveToStorage();
    }

    function buildPrintPhotoPages(){
      printPhotos.innerHTML = "";
      if (state.photos.length === 0) return;

      const perPage = 4;
      const pages = Math.ceil(state.photos.length / perPage);

      for (let p = 0; p < pages; p++){
        const pageDiv = document.createElement("div");
        pageDiv.className = "photoPage";

        const h3 = document.createElement("h3");
        h3.textContent = `Site Photos (Page ${p+1} of ${pages})`;
        pageDiv.appendChild(h3);

        const grid = document.createElement("div");
        grid.className = "photoGridPrint";

        const slice = state.photos.slice(p*perPage, p*perPage + perPage);
        for (const photo of slice){
          const wrap = document.createElement("div");
          wrap.className = "photoBig";
          const label = photo.caption ? photo.caption : photo.name;

          wrap.innerHTML = `
            <img src="${photo.dataUrl}" alt="${escapeHtml(photo.name)}" />
            <div class="label">${escapeHtml(label || "")}</div>
          `;
          grid.appendChild(wrap);
        }

        pageDiv.appendChild(grid);
        printPhotos.appendChild(pageDiv);
      }
    }

    // ---------- Export / Download / Share ----------
    function buildHtmlSnapshot(){
      buildPrintPhotoPages();

      const doc = document.documentElement.cloneNode(true);

      function setValueAttr(id){
        const el = document.getElementById(id);
        const cloneEl = doc.querySelector("#" + CSS.escape(id));
        if (el && cloneEl){
          if (cloneEl.tagName === "TEXTAREA"){
            cloneEl.textContent = el.value || "";
          } else {
            cloneEl.setAttribute("value", el.value || "");
          }
        }
      }

      ["jobNo","jobDate","community","address","lotBlockPlan","crewChief"].forEach(setValueAttr);

      const notesClone = doc.querySelector("#notes");
      if (notesClone) notesClone.textContent = notes.value || "";

      const sumClone = doc.querySelector("#officeSummary");
      if (sumClone) sumClone.textContent = officeSummary.value || "";

      const areaClone = doc.querySelector("#areaSelect");
      if (areaClone){
        const val = areaSelect.value;
        Array.from(areaClone.options).forEach(o => o.selected = (o.value === val));
      }

      const pi = doc.querySelector("#photoInput");
      if (pi) pi.remove();

      const snapPrint = doc.querySelector("#printPhotos");
      if (snapPrint) snapPrint.innerHTML = printPhotos.innerHTML;

      const subtitle = doc.querySelector(".brand .subtitle");
      if (subtitle) subtitle.textContent = "Survey Grading Check Report (shareable snapshot)";

      return "<!DOCTYPE html>\n" + doc.outerHTML;
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 2000);
      return blob;
    }

    async function handleDownload(){
      const name = defaultFileName("html");
      const snapshot = buildHtmlSnapshot();
      downloadFile(name, snapshot, "text/html");
    }

    async function handleShare(){
      const name = defaultFileName("html");
      const snapshot = buildHtmlSnapshot();
      const blob = new Blob([snapshot], { type: "text/html" });
      const file = new File([blob], name, { type: "text/html" });

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
        try{
          await navigator.share({
            title: "Vista Geomatics – Grading Check",
            text: "Grading check report attached.",
            files: [file]
          });
          return;
        }catch(e){
          // user cancelled or share failed
        }
      }

      downloadFile(name, snapshot, "text/html");
      alert("Share isn't available in this browser, the report was downloaded instead.");
    }

    function exportToPrint(){
      buildPrintPhotoPages();
      window.print();
    }

    // ---------- Storage ----------
    function saveToStorage(showToast=false){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        if (showToast){
          btnSave.textContent = "Saved";
          setTimeout(() => btnSave.textContent = "Save", 900);
        }
      }catch(e){
        console.warn("Save failed", e);
        alert("Save failed. This is usually caused by too many photos stored in the browser. Try removing some photos.");
      }
    }

    function loadFromStorage(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return false;

        state.meta = Object.assign(state.meta, parsed.meta || {});
        state.elevRows = Array.isArray(parsed.elevRows) ? parsed.elevRows : [];
        state.slopeRows = Array.isArray(parsed.slopeRows) ? parsed.slopeRows : [];
        state.photos = Array.isArray(parsed.photos) ? parsed.photos : [];
        return true;
      }catch(e){
        return false;
      }
    }

    function syncMetaToUI(){
      areaSelect.value = state.meta.area || "calgary";
      jobNo.value = state.meta.jobNo || "";
      jobDate.value = state.meta.jobDate || "";
      community.value = state.meta.community || "";
      address.value = state.meta.address || "";
      lotBlockPlan.value = state.meta.lotBlockPlan || "";
      crewChief.value = state.meta.crewChief || "";
      notes.value = state.meta.notes || "";
    }

    function initDefaults(){
      if (state.elevRows.length === 0){
        state.elevRows.push({ id: uid(), pointName: "ROW", designElev: "", fieldElev: "", note: "" });
        state.elevRows.push({ id: uid(), pointName: "Front Lot Grade (FL)", designElev: "", fieldElev: "", note: "" });
      }
      if (state.slopeRows.length === 0){
        state.slopeRows.push({ id: uid(), segment: "Front (FL → ROW)", fromPoint: "Front Lot Grade (FL)", toPoint: "ROW", distanceM: "" });
      }
    }

    // ---------- Office Summary ----------
    function getOutOfToleranceList(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;
      const out = [];

      for (const r of state.elevRows){
        const designM = normalizeElevToMeters(r.designElev);
        const fieldM  = normalizeElevToMeters(r.fieldElev);
        const dCm = calcDeltaCm(fieldM, designM);
        if (!Number.isFinite(dCm)) continue;
        if (Math.abs(dCm) > tol){
          out.push({
            point: (r.pointName || "").trim() || "Unnamed point",
            deltaCm: dCm,
            note: (r.note || "").trim()
          });
        }
      }

      // Sort by worst first
      out.sort((a,b) => Math.abs(b.deltaCm) - Math.abs(a.deltaCm));
      return out;
    }

    function getSlopeIssues(){
      // Not pass/fail, just highlights biggest delta slopes if present
      const out = [];
      for (const s of state.slopeRows){
        const from = state.elevRows.find(r => (r.pointName || "").trim() === (s.fromPoint || "").trim());
        const to   = state.elevRows.find(r => (r.pointName || "").trim() === (s.toPoint || "").trim());
        const runM = Number(String(s.distanceM || "").trim().replace(",", "."));
        const designSlope = slopePercent(normalizeElevToMeters(from?.designElev), normalizeElevToMeters(to?.designElev), runM);
        const fieldSlope  = slopePercent(normalizeElevToMeters(from?.fieldElev), normalizeElevToMeters(to?.fieldElev), runM);
        const deltaSlope  = (Number.isFinite(designSlope) && Number.isFinite(fieldSlope)) ? (fieldSlope - designSlope) : null;

        if (Number.isFinite(deltaSlope)){
          out.push({
            segment: (s.segment || "").trim() || `${(s.fromPoint||"")} → ${(s.toPoint||"")}`,
            delta: deltaSlope,
            field: fieldSlope,
            design: designSlope
          });
        }
      }
      out.sort((a,b) => Math.abs(b.delta) - Math.abs(a.delta));
      return out;
    }

    function generateOfficeSummary(){
      const tol = tolByAreaCm[state.meta.area] ?? 15;

      let pointsChecked = 0;
      let fails = 0;
      let worstSigned = null;
      let worstAbs = null;
      let worstPoint = null;

      for (const r of state.elevRows){
        const designM = normalizeElevToMeters(r.designElev);
        const fieldM  = normalizeElevToMeters(r.fieldElev);
        const dCm = calcDeltaCm(fieldM, designM);
        if (!Number.isFinite(dCm)) continue;

        pointsChecked++;
        if (Math.abs(dCm) > tol) fails++;

        const abs = Math.abs(dCm);
        if (worstAbs === null || abs > worstAbs){
          worstAbs = abs;
          worstSigned = dCm;
          worstPoint = (r.pointName || "").trim() || "Unnamed point";
        }
      }

      const outTol = getOutOfToleranceList();
      const slopeIssues = getSlopeIssues();

      const metaBits = [];
      if (state.meta.jobNo) metaBits.push(`Job ${state.meta.jobNo}`);
      if (state.meta.community) metaBits.push(state.meta.community);
      if (state.meta.address) metaBits.push(state.meta.address);
      if (state.meta.lotBlockPlan) metaBits.push(state.meta.lotBlockPlan);
      if (state.meta.crewChief) metaBits.push(`Crew: ${state.meta.crewChief}`);

      const header = `${areaLabel()} (±${tol} cm). ${metaBits.length ? metaBits.join(", ") + ". " : ""}`.trim();

      const stats = `${pointsChecked} point${pointsChecked===1?"":"s"} checked, ${fails} out of tolerance.`;
      const worst = (worstSigned === null)
        ? `Largest variance: —.`
        : `Largest variance: ${fmt(worstSigned,1)} cm at ${worstPoint}.`;

      const outLine = outTol.length
        ? `Out of tolerance items: ${outTol.slice(0,6).map(x => `${x.point} (${fmt(x.deltaCm,1)} cm)`).join(", ")}${outTol.length>6 ? ", plus additional items." : "."}`
        : `All checked points within tolerance.`;

      const slopeLine = slopeIssues.length
        ? `Slope check: largest Δ slope ${fmt(slopeIssues[0].delta,2)}% on ${slopeIssues[0].segment}.`
        : `Slope check: not recorded.`;

      const photoLine = `${state.photos.length} site photo${state.photos.length===1?"":"s"} attached.`;

      // Templates included (for consistency)
      const templateLines = NOTE_TEMPLATES
        .filter(t => state.meta.templates[t.id])
        .map(t => t.text);

      const manualNotes = (notes.value || "").trim();
      const noteBlock = [];
      if (templateLines.length){
        noteBlock.push("Notes:");
        for (const l of templateLines) noteBlock.push(`- ${l}`);
      }
      if (manualNotes){
        noteBlock.push(templateLines.length ? "Additional crew notes:" : "Notes:");
        for (const line of manualNotes.split("\n").map(s=>s.trim()).filter(Boolean)){
          noteBlock.push(`- ${line}`);
        }
      }

      const pointNotes = outTol
        .filter(x => x.note)
        .slice(0,6)
        .map(x => `- ${x.point}: ${x.note}`);

      const pointNoteBlock = pointNotes.length ? ["Point notes (key):", ...pointNotes] : [];

      const final = [
        header,
        stats,
        worst,
        outLine,
        slopeLine,
        photoLine,
        "",
        ...noteBlock,
        ...(noteBlock.length ? [""] : []),
        ...pointNoteBlock
      ].join("\n").trim();

      officeSummary.value = final;
      saveToStorage();
    }

    async function copyOfficeSummary(){
      const text = (officeSummary.value || "").trim();
      if (!text){
        alert("Nothing to copy. Click Generate first.");
        return;
      }
      try{
        await navigator.clipboard.writeText(text);
        btnCopySummary.textContent = "Copied";
        setTimeout(() => btnCopySummary.textContent = "Copy", 900);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        btnCopySummary.textContent = "Copied";
        setTimeout(() => btnCopySummary.textContent = "Copy", 900);
      }
    }

    // ---------- Events ----------
    areaSelect.addEventListener("change", () => {
      state.meta.area = areaSelect.value;
      renderTolerance();
      for (const r of state.elevRows) updateElevationComputed(r.id);
      saveToStorage();
    });

    function bindMetaInput(el, key){
      el.addEventListener("input", () => {
        state.meta[key] = el.value;
        saveToStorage();
      });
    }

    bindMetaInput(jobNo, "jobNo");
    bindMetaInput(jobDate, "jobDate");
    bindMetaInput(community, "community");
    bindMetaInput(address, "address");
    bindMetaInput(lotBlockPlan, "lotBlockPlan");
    bindMetaInput(crewChief, "crewChief");

    notes.addEventListener("input", () => {
      state.meta.notes = notes.value;
      saveToStorage();
    });

    officeSummary.addEventListener("input", () => saveToStorage());

    templateGrid.addEventListener("change", (e) => {
      const t = e.target;
      if (!t || t.type !== "checkbox") return;
      const id = t.dataset.tpl;
      if (!id) return;
      state.meta.templates[id] = t.checked;
      applyTemplatesToNotes();
      saveToStorage();
    });

    elevBody.addEventListener("input", (e) => {
      const t = e.target;
      if (!t?.dataset?.id) return;

      const id = t.dataset.id;
      const k = t.dataset.k;

      const row = state.elevRows.find(r => r.id === id);
      if (!row) return;

      row[k] = t.value;

      if (k === "designElev" || k === "fieldElev"){
        updateElevationComputed(id);
      } else if (k === "pointName"){
        // Rebuild slope dropdown options (but keep focus on current input)
        const active = document.activeElement;
        renderSlopes(true);
        if (active && active.focus) active.focus();
      }
      saveToStorage();
    });

    elevBody.addEventListener("click", (e) => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const rowId = chip.dataset.id;
      const text = chip.dataset.chip || "";
      const row = state.elevRows.find(r => r.id === rowId);
      if (!row) return;

      const current = (row.note || "").trim();
      if (!current){
        row.note = text;
      } else if (!current.includes(text)){
        row.note = current + ", " + text;
      }

      // Update the input without rerendering whole table
      const tr = elevBody.querySelector(`tr[data-row-id="${CSS.escape(rowId)}"]`);
      const noteInput = tr?.querySelector('input[data-k="note"]');
      if (noteInput) noteInput.value = row.note;

      saveToStorage();
    });

    slopeBody.addEventListener("input", (e) => {
      const t = e.target;
      if (!t?.dataset?.id) return;

      const id = t.dataset.id;
      const k = t.dataset.k;

      const row = state.slopeRows.find(r => r.id === id);
      if (!row) return;

      row[k] = t.value;
      if (k === "distanceM") updateSlopeComputed(id);
      saveToStorage();
    });

    slopeBody.addEventListener("change", (e) => {
      const t = e.target;
      if (!t?.dataset?.id) return;
      if (t.tagName !== "SELECT") return;

      const id = t.dataset.id;
      const k = t.dataset.k;

      const row = state.slopeRows.find(r => r.id === id);
      if (!row) return;

      row[k] = t.value;
      updateSlopeComputed(id);
      saveToStorage();
    });

    btnAddRow.addEventListener("click", () => {
      state.elevRows.push({ id: uid(), pointName: "", designElev: "", fieldElev: "", note: "" });
      renderElevations();
      saveToStorage();
    });

    btnRemoveSelected.addEventListener("click", () => {
      const checks = Array.from(document.querySelectorAll(".rowSel:checked"));
      const ids = new Set(checks.map(c => c.dataset.id));
      state.elevRows = state.elevRows.filter(r => !ids.has(r.id));
      renderElevations();
      saveToStorage();
    });

    btnAddDefaults.addEventListener("click", () => {
      const defaults = [
        "ROW","TOC","Sidewalk","Driveway",
        "Front Lot Grade (FL)","Garage Slab","Front Swale",
        "Left Side Yard","Right Side Yard",
        "Rear Lot Grade (RL)","Rear Swale / Lane"
      ];
      const existing = new Set(state.elevRows.map(r => (r.pointName || "").trim()).filter(Boolean));
      for (const name of defaults){
        if (!existing.has(name)){
          state.elevRows.push({ id: uid(), pointName: name, designElev: "", fieldElev: "", note: "" });
        }
      }
      renderElevations();
      saveToStorage();
    });

    btnAddSlope.addEventListener("click", () => {
      state.slopeRows.push({ id: uid(), segment: "", fromPoint: "", toPoint: "", distanceM: "" });
      renderSlopes(true);
      saveToStorage();
    });

    btnRemoveSlopeSelected.addEventListener("click", () => {
      const checks = Array.from(document.querySelectorAll(".slopeSel:checked"));
      const ids = new Set(checks.map(c => c.dataset.id));
      state.slopeRows = state.slopeRows.filter(r => !ids.has(r.id));
      renderSlopes(true);
      saveToStorage();
    });

    btnSave.addEventListener("click", () => saveToStorage(true));

    btnReset.addEventListener("click", () => {
      if (!confirm("Clear this grading check from this device?")) return;
      localStorage.removeItem(STORAGE_KEY);

      state.meta = { area:"calgary", jobNo:"", jobDate:"", community:"", address:"", lotBlockPlan:"", crewChief:"", notes:"", templates:{} };
      state.elevRows = [];
      state.slopeRows = [];
      state.photos = [];
      officeSummary.value = "";

      initDefaults();
      syncMetaToUI();
      renderTemplates();
      renderTolerance();
      renderElevations();
      renderThumbs();
      saveToStorage();
    });

    btnDownload.addEventListener("click", async () => {
      await handleDownload();
    });

    btnShare.addEventListener("click", async () => {
      await handleShare();
    });

    btnPrint.addEventListener("click", () => exportToPrint());

    btnGenSummary.addEventListener("click", () => generateOfficeSummary());
    btnCopySummary.addEventListener("click", () => copyOfficeSummary());

    // Photos
    photoInput.addEventListener("change", async (e) => {
      const files = e.target.files;
      if (!files || files.length === 0) return;
      await addPhotosFromFiles(files);
      photoInput.value = "";
    });

    thumbGrid.addEventListener("click", (e) => {
      const t = e.target;
      const card = t.closest(".thumb");
      if (!card) return;
      const pid = card.dataset.pid;

      if (t.dataset.action === "remove"){
        removePhoto(pid);
        return;
      }
      const photo = state.photos.find(p => p.id === pid);
      if (!photo) return;
      const cap = prompt("Photo caption (optional):", photo.caption || "");
      if (cap !== null){
        photo.caption = cap.trim();
        renderThumbs();
        saveToStorage();
      }
    });

    btnClearPhotos.addEventListener("click", () => clearPhotos());

    // ---------- Init ----------
    function saveToStorageSafe(){
      saveToStorage();
    }

    function loadAndInit(){
      loadFromStorage();
      state.meta.area = state.meta.area || "calgary";
      if (!state.meta.jobDate) state.meta.jobDate = todayISO();

      initDefaults();
      syncMetaToUI();

      renderTemplates();
      renderTolerance();
      renderElevations();
      renderThumbs();

      saveToStorageSafe();
    }

    loadAndInit();
  </script>
</body>
</html>
